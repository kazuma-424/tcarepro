<br>
<br>
<br>
<br>

<!--<table class="header-table space" width="90%">
  <tr>
    <th colspan="10">ステータス別結果</th>
  </tr>
  <tr>
    <th></th>
    <th>着信留守</th>
    <th>担当者不在</th>
    <th>見込</th>
    <th>コロナ見込</th>
    <th>折返待</th>
    <th>APP</th>
    <th>キャンセル</th>
    <th>フロントNG</th>
    <th>根本的NG</th>
    <th>永久NG</th>
  </tr>
  <tr>
    <!% @users.each do |user| %>
    <th><!%= user.user_name %></th>
    <td><!%= user.calls.where(statu: "着信留守").count %></td>
    <td><!%= user.calls.where(statu: "担当者不在").count %></td>
    <td><!%= user.calls.where(statu: "見込").count %></td>
    <td><!%= user.calls.where(statu: "コロナ見込").count %></td>
    <td><!%= user.calls.where(statu: "折返待").count %></td>
    <td><!%= user.calls.where(statu: "APP").count %></td>
    <td><!%= user.calls.where(statu: "キャンセル").count %></td>
    <td><!%= user.calls.where(statu: "フロントNG").count %></td>
    <td><!%= user.calls.where(statu: "根本的NG").count %></td>
    <td><!%= user.calls.where(statu: "永久NG").count %></td>
  </tr>
  <tr>
    <th></th>
    <td><!%= number_to_percentage(user.calls.where(statu: "着信留守").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "担当者不在").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "見込").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "コロナ見込").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "折返待").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "APP").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "キャンセル").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "フロントNG").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "根本的NG").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "永久NG").count / @call_count.count.to_f * 100, precision: 1 ) %></td>
  </tr>
<!% end %>
</table>-->

<table class="header-table space" width="90%">
  <tr>
    <th colspan="6">１日のコール状況</th>
  </tr>
  <tr>
    <th></th>
    <th>コール数</th>
    <th>見込獲得数</th>
    <th>アポ数</th>
    <th>見込獲得数</th>
    <th>アポ獲得率</th>
  </tr>
  <tr>
    <th>1日のコール状況</th>
    <td><%= @call_count_today %>Call</td>
    <td><%= @protect_count_today %>件</td>
    <td><%= @app_count_today %>件</td>
    <td><%= @protect_convertion_today.ceil(2) %>%</td>
    <td><%= @app_convertion_today.ceil(2) %>%</td>
  </tr>
  <tr>
    <th>1週間のコール状況</th>
    <td><%= @call_count_week %>Call</td>
    <td><%= @protect_count_week %>件</td>
    <td><%= @app_count_week %>件</td>
    <td><%= @protect_convertion_week.ceil(2) %>%</td>
    <td><%= @app_convertion_week.ceil(2) %>%</td>
  </tr>
  <tr>
    <th>1ヶ月のコール状況</th>
    <td><%= @call_count_month %>Call</td>
    <td><%= @protect_count_month %>件</td>
    <td><%= @app_count_month %>件</td>
    <td><%= @protect_convertion_month.ceil(2) %>%</td>
    <td><%= @app_convertion_month.ceil(2) %>%</td>
  </tr>
</table>
<br>
<br>
<br>
<br>
<table class="header-table space" width="90%">
  <tr>
    <th colspan="10">ステータス別結果</th>
  </tr>
  <tr>
    <th>着信留守</th>
    <th>担当者不在</th>
    <th>見込</th>
    <th>APP</th>
    <th>キャンセル</th>
    <th>NG</th>
  </tr>
  <tr>
    <td><%= @call_count_called.count %></td>
    <td><%= @call_count_absence.count %></td>
    <td><%= @call_count_prospect.count %></td>
    <td><%= @call_count_app.count %></td>
    <td><%= @call_count_cancel.count %></td>
    <td><%= @call_count_ng.count %></td>
  </tr>
  <tr>
    <td><%= number_to_percentage(@call_count_called.count / @call_count_month.to_f * 100, precision: 1 ) %></td>
    <td><%= number_to_percentage(@call_count_absence.count / @call_count_month.to_f * 100, precision: 1 ) %></td>
    <td><%= number_to_percentage(@call_count_prospect.count / @call_count_month.to_f * 100, precision: 1 ) %></td>
    <td><%= number_to_percentage(@call_count_app.count / @call_count_month.to_f * 100, precision: 1 ) %></td>
    <td><%= number_to_percentage(@call_count_cancel.count / @call_count_month.to_f * 100, precision: 1 ) %></td>
    <td><%= number_to_percentage(@call_count_ng.count / @call_count_month.to_f * 100, precision: 1 ) %></td>
  </tr>
</table>
<br>
<br>
<br>
<br>
<table class="header-table space" width="90%">
  <tr>
    <th colspan="6">企業別アポ状況</th>
  </tr>
  <tr>
    <th>企業名</th>
    <th>コール数</th>
    <th>アポ数</th>
    <th>アポ率</th>
    <th>残アポ数</th>
  </tr>
  <tr>
    <% sorairo = (@detail_sorairo.present? ? @detail_sorairo.to_a : 0 ) %>
    <% @detailAppCount = (sorairo == 0 ? 0 : sorairo.select { |call| call.statu == "APP" }.count) %>
    <% @detailRemainCount = (@detailAppCount > 30) ? 0 : 30 - @detailAppCount %>
    <th>SORAIRO</th>
    <td><%= sorairo == 0 ? sorairo : sorairo.count %></td>
    <td><%= @detailAppCount %></td>
    <td><%= number_to_percentage(sorairo == 0 ? 0 : @detailAppCount * 100.0 / sorairo == 0 ? 0 : sorairo.count, precision: 1 ) %></td>
    <td><%= @detailRemainCount %></td>
    <%# <% @detailCount = @detailcalls.where("industry LIKE ?", "%SORAIRO%").where("calls.created_at > ?", Time.current.beginning_of_month).where("calls.created_at < ?", Time.current.end_of_month).count %>
    <%# <% @detailAppCount = @detailcalls.where("industry LIKE ?", "%SORAIRO%").where("calls.statu": "APP").where("calls.created_at > ?", Time.current.beginning_of_month).where("calls.created_at < ?", Time.current.end_of_month).count %>
    <%# <% @detailRemainCount = (@detailAppCount > 30) ? 0 : 30 - @detailAppCount %>
    <!--<th>SORAIRO</th>
    <td><!%= @detailCount %></td>
    <td><!%= @detailAppCount %></td>
    <td><!%= number_to_percentage(@detailCount <= 0 ? 0 : @detailAppCount * 100.0 / @detailCount, precision: 1 ) %></td>
    <td><!%= @detailRemainCount %></td>-->
  </tr>
  <tr>
    <% ikebukuro = (@detail_ikebukuro.present? ? @detail_ikebukuro.to_a : 0) %>
    <% @detailAppCount = (ikebukuro == 0 ? 0 : ikebukuro.select { |call| call.statu == "APP" }.count) %>
    <% @detailRemainCount = (@detailAppCount > 20) ? 0 : 20 - @detailAppCount %>
    <th>JAIC池袋</th>
    <td><%= ikebukuro == 0 ? 0 : @detail_ikebukuro.count %></td>
    <td><%= @detailAppCount %></td>
    <td><%= number_to_percentage(ikebukuro == 0 ? 0 : @detailAppCount * 100.0 / ikebukuro == 0 ? 0 : ikebukuro.count, precision: 1 ) %></td>
    <td><%= @detailRemainCount %></td>
    <%# <% @detailCount = @detailcalls.where("industry LIKE ?", "%JAIC池袋%").where("calls.created_at > ?", Time.current.beginning_of_month).where("calls.created_at < ?", Time.current.end_of_month).count %>
    <%# <% @detailAppCount = @detailcalls.where("industry LIKE ?", "%JAIC池袋%").where("calls.statu": "APP").where("calls.created_at > ?", Time.current.beginning_of_month).where("calls.created_at < ?", Time.current.end_of_month).count %>
    <%# <% @detailRemainCount = (@detailAppCount > 20) ? 0 : 20 - @detailAppCount %>
    <!--<th>JAIC池袋</th>
    <td><!%= @detailCount %></td>
    <td><!%= @detailAppCount %></td>
    <td><!%= number_to_percentage(@detailCount <= 0 ? 0 : @detailAppCount * 100.0 / @detailCount, precision: 1 ) %></td>
    <td><!%= @detailRemainCount %></td>-->
  </tr>
  <tr>
    <% apotaku = (@detail_apotaku.present? ? @detail_apotaku.to_a : 0) %>
    <% @detailAppCount = (apotaku == 0 ? 0 : apotaku.select { |call| call.statu == "APP" }.count) %>
    <% @detailRemainCount = (@detailAppCount > 50) ? 0 : 20 - @detailAppCount %>
    <th>アポ匠</th>
    <td><%= apotaku == 0 ? 0 : apotaku.count %></td>
    <td><%= @detailAppCount %></td>
    <td><%= number_to_percentage(apotaku == 0 ? 0 : @detailAppCount * 100.0 / apotaku == 0 ? 0 : apotaku.count, precision: 1 ) %></td>
    <td><%= @detailRemainCount %></td>
    <%# <% @detailCount = @detailcalls.where("industry LIKE ?", "%アポ匠%").where("calls.created_at > ?", Time.current.beginning_of_month).where("calls.created_at < ?", Time.current.end_of_month).count %>
    <%# <% @detailAppCount = @detailcalls.where("industry LIKE ?", "%アポ匠%").where("calls.statu": "APP").where("calls.created_at > ?", Time.current.beginning_of_month).where("calls.created_at < ?", Time.current.end_of_month).count %>
    <%# <% @detailRemainCount = (@detailAppCount > 50) ? 0 : 20 - @detailAppCount %>
    <!--<th>アポ匠</th>
    <td><!%= @detailCount %></td>
    <td><!%= @detailAppCount %></td>
    <td><!%= number_to_percentage(@detailCount <= 0 ? 0 : @detailAppCount * 100.0 / @detailCount, precision: 1 ) %></td>
    <td><!%= @detailRemainCount %></td>-->
  </tr>
  <tr>
  </tr>
</table>
<br>
<br>
<br>
<br>
<table class="header-table space" width="90%">
  <tr>
    <th colspan="7">スタッフ別コール</th>
  </tr>
  <tr>
    <th>スタッフ名</th>
    <th>コール数</th>
    <th>月間コール数</th>
    <th>見込数</th>
    <th>APP数</th>
    <th>キャンセル数</th>
    <th>APP率</th>
  </tr>
  <% @users.each do |user| %>
  <% user_calls_month = user.calls.where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).to_a %>
  <tr>
    <td><%= user.user_name %></td>
    <td><%= user.calls.where('created_at > ?', Time.current.beginning_of_day).where('created_at < ?', Time.current.end_of_day).count %></td>
    <td><%= user_calls_month.count %></td>
    <td><%= user_calls_month.select { |call| call.statu == "見込" }.count %></td>
    <td><%= user_app = user_calls_month.select { |call| call.statu == "APP" }.count %></td>
    <td><%= user_calls_month.select { |call| call.statu == "キャンセル" }.count %></td>
    <td><%= number_to_percentage(user_app.to_f / user_calls_month.count.to_f * 100, precision: 1) %></td>
    <!--<td><!%= user.calls.where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).count  %></td>
    <td><!%= user.calls.where(statu: "見込").where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).count %></td>
    <td><!%= user.calls.where(statu: "APP").where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).count %></td>
    <td><!%= user.calls.where(statu: "キャンセル").where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).count %></td>
    <td><!%= number_to_percentage(user.calls.where(statu: "APP").where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).count.to_f / user.calls.where('created_at > ?', Time.current.beginning_of_month).where('created_at < ?', Time.current.end_of_month).count.to_f * 100, precision: 1) %></td>-->
  </tr>
  <%end%>
</table>
<br>
<br>
<br>
<br>
<div class="text-center">
<%= link_to "時間別コール、スタッフ&シェアフル時間別コールへ", analytics2_path, class: "btn btn-success btn-lg text-white" %>
</div>
<br>
<br>
<br>
<br>
<%= form_tag call_import_customers_path, multipart: true do %>
   <table width="90%" class="space">
     <tbody>
        <tr>
           <th colspan="3">CALL_CSVファイルインポート</th>
        </tr>
        <tr>
           <td><%= file_field_tag :call_file %></td>
           <th><%= submit_tag "インポート",  class: 'btn btn-success' %></th>
           <th><%= link_to 'エクスポート', analytics_path(format: :csv), class: 'btn btn-success' %></th>
        </tr>
    </tbody>
   </table>
<% end %>
